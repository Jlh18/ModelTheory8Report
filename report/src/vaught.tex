In this section we go back to general model theory,
with the goal of proving \linkto{vaught_test}{Vaught's test}.
However, the proof of Vaught's test relies on a (a variant of) the
\linkto{upwards_lowenheim_skolem}{Upwards L\"{o}wenheim-Skolem Theorem}.
It says the following:

\begin{prop}[Upwards L\"{o}wenheim-Skolem]
  \link{upwards_lowenheim_skolem}
  Suppose $L$ is an algebraic language and $T$ is an $L$-theory.
  If $\kappa$ is a sufficiently large cardinal and $T$ has an infinite model,
  then $T$ has a model of size $\kappa$.

  \begin{lstlisting}
theorem has_sized_model_of_has_infinite_model [is_algebraic L] {T : Theory L} {κ : cardinal}
  (hκ : ∀ n, #(L.functions n) ≤ κ) (hωκ : ω ≤ κ) :
  (∃ M : Structure L, nonempty M ∧ M ⊨ T ∧ infinite M) →
  ∃ M : Structure L, nonempty M ∧ M ⊨ T ∧ #M = κ := sorry \end{lstlisting}
\end{prop}

This is often stated in terms of starting with an $L$-structure,
and extending it to a larger $L$-structure,
hence the word ``upward'' in the name.
This can be done using the above by taking $T$ to be the set of
sentences satisfied by the structure.

\subsection{Proof of Vaught's Test}
\link{vaught_proof}

We first apply \linkto{upwards_lowenheim_skolem}{
  Upwards L\"{o}wenheim-Skolem} to prove \linkto{vaught_test}{Vaught's test}.
Recall the statement:

\begin{lstlisting}
lemma is_complete'_of_only_infinite_of_categorical
  [is_algebraic L] {T : Theory L} (M : Structure L) (hM : M ⊨ T)
  (hinf : only_infinite T) {κ : cardinal}
  (hκ : ∀ n, #(L.functions n) ≤ κ) (hωκ : ω ≤ κ) (hcat : categorical κ T) :
  is_complete' T := sorry \end{lstlisting}

\begin{proof}
The proof is by contradiction.
Suppose $T$ is not complete;
this gives us a formula $\phi$ such that
\[ T \nvDash \phi \quad \text{and} \quad T \nvDash \neg \phi \]
which in turn (after unfolding the definition of $T \nvDash \phi$)
gives us two models $M$ and $N$ of $T$ such that
\[ M \nvDash \phi \quad \text{and} \quad N \nvDash \neg \phi \]
our aim is to adjust these to two models of $T$
of cardinality $\kappa$ so that they are isomorphic by categoricity,
but satisfy different sentences.

\begin{lstlisting}
begin
  intro ϕ,
  by_contra hbot,
  simp only [not_or_distrib, not_ssatisfied] at hbot,
  obtain ⟨ ⟨ M , hM0 , hM ⟩ , ⟨ N , hN0 , hN ⟩ ⟩ := hbot,
\end{lstlisting}

We can adjust cardinality using Upwards L\"{o}wenheim-Skolem,
obtaining models of cardinality $\kappa$.
This is why we need $T$ to only have infinite models.
\begin{lstlisting}
  obtain ⟨ M' , hM'0 , hM' , hMcard ⟩ := has_sized_model_of_has_infinite_model hκ hωκ
    ⟨
      M , hM0 , hM ,
      hinf ⟨ M , all_realize_sentence_of_subset hM (set.subset_insert _ _) ⟩
    ⟩,
  obtain ⟨ N' , hN'0 , hN' , hNcard ⟩ := has_sized_model_of_has_infinite_model hκ hωκ
    ⟨
      N , hN0 , hN ,
      hinf ⟨ N , all_realize_sentence_of_subset hN (set.subset_insert _ _) ⟩
    ⟩, \end{lstlisting}

By categoricity, $M$ and $N$ are isomorphic as $L$-structures.
We supply a proof that isomorphic structures satisfy the same
sentences in \texttt{Rings.ToMathlib.fol.lean}.
It follows from a series of proofs by induction on terms and formulas.

\begin{lstlisting}
  have hiso := hcat M' N'
    (all_realize_sentence_of_subset hM' (set.subset_insert _ _))
    (all_realize_sentence_of_subset hN' (set.subset_insert _ _)) hMcard hNcard,
  rw all_realize_sentence_insert at hM' hN',
  rw Language.equiv.realize_sentence _ (classical.choice hiso) at hN',
  exact hN'.1 hM'.1,
end
\end{lstlisting}
\end{proof}

\subsection{Upwards L\"{o}wenheim-Skolem}

Our remaining goal is to prove
\linkto{upwards_lowenheim_skolem}{Upwards L\"{o}wenheim-Skolem}.

\begin{lstlisting}
theorem has_sized_model_of_has_infinite_model [is_algebraic L] {T : Theory L} {κ : cardinal}
  (hκ : ∀ n, #(L.functions n) ≤ κ) (hωκ : ω ≤ κ) :
  (∃ M : Structure L, nonempty M ∧ M ⊨ T ∧ infinite M) →
  ∃ M : Structure L, nonempty M ∧ M ⊨ T ∧ #M = κ := sorry \end{lstlisting}

The idea of the proof is that we want to design a model of the right size
by making a language $L'$ extending $L$ and an $L'$-theory $T'$ extending $T$
(extending in the sense that any $L'$-model of $T'$ reduces down to a $L$-model of $T$),
such that the design of $L'$ and $T'$ guarantee that any model of $T'$ is large enough.
Meanwhile, we design the most obvious $L'$-model \texttt{term\_model} of $T'$,
by taking the type of all the $L'$-terms, and quotienting by equality deduced by $T'$,
guaranteeing that \texttt{term\_model} is small enough.
